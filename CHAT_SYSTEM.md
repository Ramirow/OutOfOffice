# Chat System Documentation

## Overview
The chat system allows users to send messages to matched attendees from attended events. All chat history is stored in Firestore and persists across app sessions.

## Database Structure

### 1. `chats` Collection
**Purpose:** Store chat conversations between two users for a specific event

**Document ID:** `{userId1}_{userId2}_{eventId}` (user IDs are sorted alphabetically for consistency)

**Document Structure:**
```javascript
{
  id: "5_7_123",              // userId1_userId2_eventId
  userId1: "5",               // Smaller user ID (alphabetically)
  userId2: "7",               // Larger user ID (alphabetically)
  eventId: "123",
  eventTitle: "Tech Meetup",
  eventImage: "https://...",
  createdAt: Timestamp,
  updatedAt: Timestamp,
  lastMessage: "Hey! How are you?",
  lastMessageAt: Timestamp
}
```

### 2. `messages` Collection
**Purpose:** Store individual messages in chats

**Document ID:** Auto-generated by Firestore

**Document Structure:**
```javascript
{
  id: "message_abc123",
  chatId: "5_7_123",
  senderId: "5",
  text: "Hey! How are you?",
  timestamp: Timestamp,
  read: false
}
```

## Services

### ChatService
Located in `src/services/ChatService.js`

**Key Methods:**
- `getOrCreateChat(userId1, userId2, eventId, event)` - Creates or retrieves a chat
- `sendMessage(chatId, senderId, text)` - Sends a message and updates chat metadata
- `getChatMessages(chatId)` - Retrieves all messages for a chat
- `getUserChats(userId)` - Gets all chats for a user (sorted by most recent)
- `getChatDetails(chatId, currentUserId)` - Gets chat details with other user info
- `markMessagesAsRead(chatId, userId)` - Marks messages as read

## Components

### ChatScreen
Located in `src/screens/ChatScreen.js`

**Features:**
- Displays messages in a chat
- Sends new messages to Firestore
- Loads chat history on mount
- Real-time message display
- Auto-scrolls to latest message

**Navigation:**
- Can be opened from:
  1. Event matches (after swiping)
  2. Messenger tab (existing chats)

**Props:**
- `route.params.event` - Event object
- `route.params.matches` - Array of matched users (for compatibility)
- `route.params.chatId` - Existing chat ID (from Messenger tab)
- `route.params.otherUser` - Other user object (from Messenger tab)

### MessengerTab
Located in `src/screens/MessengerTab.js`

**Features:**
- Lists all user's chats
- Shows last message preview
- Shows event name for each chat
- Displays time since last message
- Pull-to-refresh functionality
- Empty state when no chats exist

**Navigation:**
- Clicking a chat navigates to `ChatScreen` with chat details

## User Flow

### 1. Creating a Chat
1. User attends an event (event date passes)
2. User swipes on attendees and matches with someone
3. User navigates to chat screen
4. `ChatService.getOrCreateChat()` is called
5. Chat document is created in `chats` collection
6. Messages can now be sent

### 2. Sending Messages
1. User types message and clicks send
2. `ChatService.sendMessage()` is called
3. Message is saved to `messages` collection
4. Chat's `lastMessage` and `lastMessageAt` are updated
5. Message appears in UI immediately

### 3. Viewing Chat History
1. User opens Messenger tab
2. `ChatService.getUserChats()` fetches all chats
3. User profiles are loaded for each chat
4. Chats are displayed sorted by most recent activity
5. User can click any chat to view full conversation

### 4. Loading Messages
1. When ChatScreen opens, `ChatService.getChatMessages()` is called
2. All messages for the chat are loaded
3. Messages are displayed in chronological order
4. Messages are marked as read

## Firestore Indexes

The following indexes may be required (Firestore will prompt if needed):

1. **messages collection:**
   - `chatId` (ascending) + `timestamp` (ascending)

2. **chats collection:**
   - `userId1` (ascending) + `updatedAt` (descending)
   - `userId2` (ascending) + `updatedAt` (descending)

## Integration Points

### UpcomingEventsTab
- When user clicks an attended event with matches, navigates to ChatScreen
- Passes event and matches as route params

### EventAttendeesScreen
- After swiping, if matches exist, navigates to ChatScreen
- Passes event and matches as route params

### HomeScreen
- Added "MESSAGES" tab
- Displays MessengerTab component

## Future Enhancements

- Real-time message updates using Firestore listeners
- Push notifications for new messages
- Message read receipts
- Typing indicators
- Image/file attachments
- Group chats for events
- Message search functionality

